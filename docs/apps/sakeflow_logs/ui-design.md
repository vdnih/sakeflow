# SakeTrail 画面設計・機能設計ドキュメント

## 1. 画面一覧

| 画面ID | 画面名             | パス（Route）      | 概要                                   | ステータス |
|--------|--------------------|-------------------|----------------------------------------|------------|
| S01    | スプラッシュ画面   | /splash           | アプリ起動時のロゴ・ロード画面         | 未実装     |
| S02    | ログイン画面       | /login            | ユーザー認証                           | 未実装     |
| S03    | サインアップ画面   | /signup           | 新規ユーザー登録                       | 未実装     |
| S04    | ホーム/ダッシュボード | /home           | おすすめお酒・履歴・メニュー           | 未実装     |
| S05    | AIラベル認識画面   | /ai-label         | カメラでラベル撮影・AIによるお酒認識   | 未実装     |
| S06    | お酒詳細画面       | /sake-detail      | お酒の詳細情報・レビュー表示           | 未実装     |
| S07    | レビュー投稿画面   | /review           | お酒のレビュー・思い出記録             | 未実装     |
| S08    | プロフィール画面   | /profile          | ユーザー情報・設定                     | 未実装     |
| S09    | 設定画面           | /settings         | 通知・アカウント・アプリ設定           | 未実装     |
| S10    | 飲酒記録登録画面   | /record           | 判別結果をもとに飲酒記録を登録         | 未実装     |

## 2. 機能一覧

| 機能ID | 機能名             | 概要                                   | ステータス |
|--------|--------------------|----------------------------------------|------------|
| F01    | AIラベル認識       | カメラ画像からお酒（日本酒・ワイン・ビール・ウイスキー等）を自動判別 | 未実装     |
| F02    | パーソナライズ推薦 | ユーザーの好みに合わせたお酒推薦       | 未実装     |
| F03    | 飲酒記録           | 飲んだお酒の記録・検索・閲覧           | 未実装     |
| F04    | レビュー投稿       | お酒の評価・コメント・画像投稿         | 未実装     |
| F05    | ユーザー認証       | ログイン・サインアップ・ログアウト      | 未実装     |
| F06    | プロフィール編集   | ユーザー情報の編集                     | 未実装     |
| F07    | 設定変更           | 通知・アカウント・アプリ設定           | 未実装     |
| F08    | 判別→記録連携     | 判別したお酒をそのまま飲酒記録に登録   | 未実装     |

## 5. API利用一覧

| 機能ID | 画面ID | 機能名         | 画面名           | APIエンドポイント                | 実装状況 | 備考                                 |
|--------|--------|----------------|------------------|----------------------------------|----------|--------------------------------------|
| F05    | S02    | ユーザー認証   | ログイン画面     | Firebase Auth                    | 未実装   | Firebase Authenticationを利用       |
| F05    | S03    | ユーザー認証   | サインアップ画面 | Firebase Auth                    | 未実装   | Firebase Authenticationを利用       |
| F01    | S05    | AIラベル認識   | AIラベル認識画面 | POST /ai/recognize-label         | 未実装   | 画像アップロード・お酒（type）判別   |
| F08    | S10    | 判別→記録連携  | 飲酒記録登録画面 | POST /sakes/{sake_id}/records    | 未実装   | 判別結果（type含む）を飲酒記録として登録 |
| F03    | S04    | 飲酒記録       | ホーム           | GET /sakes                       | 未実装   | 一覧取得（typeでフィルタ可能）       |
| F03    | S06    | 飲酒記録       | お酒詳細画面     | GET /sakes/{sake_id}             | 未実装   | 詳細取得（type含む）                 |
| F04    | S07    | レビュー投稿   | レビュー投稿画面 | POST /sakes/{sake_id}/reviews    | 未実装   |                                      |

---

## 3. ルーティング設計（Web実装）

> **重要**: 現在の実装はWeb対応のみとなっています。将来的にはモバイル（iOS/Android）対応を予定していますが、現時点ではWebブラウザでの利用を前提とした実装となっています。モバイル対応時にはルーティング設計も変更される予定です。

- 画面ごとに明示的なパス（Route）を用意し、拡張性・保守性を高める
- 認証必須画面には認証ガード（AuthGuard）を導入
- `/`（ルート）はリダイレクト専用にし、認証状態で`/login`または`/home`に遷移

### ルーティング例（Dart）

```dart
MaterialApp(
  initialRoute: '/',
  routes: {
    '/': (context) => _loading 
                  ? const LoadingScreen()
                  : _isSignedIn 
                      ? const HomeScreen()
                      : LoginScreen(onLogin: _handleLogin),
    '/login': (context) => LoginScreen(onLogin: _handleLogin),
    '/home': (context) => AuthGuard(child: const HomeScreen(), authService: _authService),
    '/callback': (context) => const CallbackHandlerScreen(),
    // ...他の画面
  },
)
```

- `AuthGuard`は未ログイン時に`/login`へリダイレクトする仕組みを実装
- Webアプリケーションでは`/callback`ルートが特に重要（OAuth2.0認証のコールバック処理用）

## 4. 認証フロー

ユーザー認証機能（F05）の具体的な実装については、[認証フロー実装ガイド](../guides/authentication-flow.md)を参照してください。このガイドでは、Firebase Authを使用した認証フローの実装方法、コールバック処理、トークン管理などについて詳細に解説しています。

### Web認証フローの概要

```
┌─────────┐    ┌────────────────┐    ┌───────────────┐    ┌─────────────┐    ┌──────────────┐
│ ユーザー │───→│ ログインボタン │───→│ Firebase Auth │───→│ コールバック │───→│ トークン取得 │
└─────────┘    └────────────────┘    │              │    └─────────────┘    └──────────────┘
                                         └───────────────┘                             │
                                                                                       ↓
                                         ┌───────────────┐                      ┌──────────────┐
                                         │ ホーム画面    │←─────────────────────│ 認証完了     │
                                         └───────────────┘                      └──────────────┘
```

実装上の特徴：
- Webアプリ専用の実装（firebase_auth, flutterfire_uiパッケージ使用）
- ブラウザのポップアップウィンドウやリダイレクトを使用したフロー
- `callback.html`でのリダイレクト処理
- `window.opener.postMessage`を使用した親ウィンドウへの通知
- 今後、モバイル対応時にはディープリンクを使用した実装に変更予定 

---

## 6. 多様なお酒への対応・拡張性

- 本アプリは日本酒だけでなく、ワイン・ビール・ウイスキー・リキュール・焼酎など多様なお酒に対応しています。
- 画面・機能・API・DB設計すべてで「お酒の種類（type）」フィールドを考慮し、今後のカテゴリ追加も容易です。
- 検索・履歴・記録・AI判別など、すべての機能で「type」によるフィルタや表示切替が可能です。
- 生成AIの活用により、新しいお酒カテゴリへの拡張も柔軟に対応できます。 